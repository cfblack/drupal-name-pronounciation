name: Drupal 10 CI/CD

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  drupal-test:
    runs-on: ubuntu-latest
    name: PHP 8.3 - Drupal 10.5

    permissions:
      contents: read
      pull-requests: write
      issues: write

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: drupal
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout module code
        uses: actions/checkout@v4
        with:
          path: module

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: gd, pdo_mysql, opcache, mbstring, xml, json
          coverage: none
          tools: composer:v2

      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Create Drupal project
        run: |
          composer create-project drupal/recommended-project:10.5.x drupal --no-interaction
          cd drupal
          # Add Drush and development dependencies
          composer require drush/drush --no-interaction
          composer require --dev drupal/core-dev:10.5.x -W --no-interaction

      - name: Install module
        run: |
          # Create custom modules directory
          mkdir -p drupal/web/modules/custom/name_pronunciation
          # Copy module files
          cp -r module/* drupal/web/modules/custom/name_pronunciation/
          # Ensure proper permissions
          chmod -R 755 drupal/web/modules/custom/name_pronunciation

      - name: Install Drupal
        run: |
          cd drupal
          # Install Drupal using Drush
          ./vendor/bin/drush site:install standard \
            --db-url=mysql://root:root@127.0.0.1:3306/drupal \
            --site-name="Drupal CI Test" \
            --account-name=admin \
            --account-pass=admin \
            --yes

      - name: Enable the module
        run: |
          cd drupal
          ./vendor/bin/drush en name_pronunciation -y
          ./vendor/bin/drush cr

      - name: Verify module installation
        run: |
          cd drupal
          # Check if module is enabled
          ./vendor/bin/drush pm:list --type=module --status=enabled --format=json | grep -q "name_pronunciation" && echo "âœ“ Module successfully enabled" || exit 1

      - name: Run Drupal status checks
        run: |
          cd drupal
          ./vendor/bin/drush status
          ./vendor/bin/drush core:requirements

      - name: Check for PHP syntax errors
        run: |
          cd drupal/web/modules/custom/name_pronunciation
          echo "Checking PHP syntax..."
          find . -name "*.php" -exec php -l {} \;
          echo "âœ“ PHP syntax check complete"

      - name: Run PHPUnit tests (if any)
        run: |
          cd drupal
          if [ -d "web/modules/custom/name_pronunciation/tests" ]; then
            ./vendor/bin/phpunit -c web/core web/modules/custom/name_pronunciation/tests
          else
            echo "No tests found - skipping PHPUnit"
          fi
        continue-on-error: true

      - name: Check Drupal logs for errors
        if: always()
        run: |
          cd drupal
          ./vendor/bin/drush watchdog:show --severity=error --count=50 || echo "No error logs found"

      - name: Module status report
        if: always()
        run: |
          cd drupal
          echo "=== Module Status ==="
          ./vendor/bin/drush pm:list --type=module --format=table | grep -E "(Name|name_pronunciation)" || echo "Module check complete"

      # Test Environment Access for PR Reviewers
      - name: Start PHP web server
        if: github.event_name == 'pull_request'
        run: |
          cd drupal/web
          php -S 0.0.0.0:8080 .ht.router.php > /tmp/server.log 2>&1 &
          echo $! > /tmp/server.pid
          sleep 3
          echo "âœ“ Web server started on port 8080"

      - name: Install and setup cloudflared tunnel
        if: github.event_name == 'pull_request'
        run: |
          # Download cloudflared
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

          # Start tunnel in background
          cloudflared tunnel --url http://localhost:8080 > /tmp/tunnel.log 2>&1 &
          echo $! > /tmp/tunnel.pid

          # Wait for tunnel URL to be generated
          echo "Waiting for tunnel URL..."
          TUNNEL_URL=""
          for i in {1..60}; do
            if [ -f /tmp/tunnel.log ]; then
              # Try multiple patterns to extract the URL
              TUNNEL_URL=$(grep -oE 'https://[a-zA-Z0-9-]+\.trycloudflare\.com' /tmp/tunnel.log | head -1)

              if [ ! -z "$TUNNEL_URL" ]; then
                echo "âœ“ Tunnel URL found: $TUNNEL_URL"
                break
              fi
            fi

            # Show progress every 10 seconds
            if [ $((i % 10)) -eq 0 ]; then
              echo "Still waiting... ($i seconds elapsed)"
              echo "Current tunnel log contents:"
              cat /tmp/tunnel.log 2>/dev/null || echo "Log file not yet created"
            fi

            sleep 1
          done

          # Check if we got a URL
          if [ -z "$TUNNEL_URL" ]; then
            echo "âŒ Failed to get tunnel URL after 60 seconds"
            echo "Final tunnel log contents:"
            cat /tmp/tunnel.log
            exit 1
          fi

          # Export the URL for subsequent steps
          echo "TUNNEL_URL=$TUNNEL_URL" >> $GITHUB_ENV
          echo "âœ“ Tunnel created successfully: $TUNNEL_URL"

      - name: Output test environment URL to summary
        if: github.event_name == 'pull_request' && env.TUNNEL_URL != ''
        run: |
          echo "## ðŸ§ª Test Environment Ready!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Access Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** $TUNNEL_URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Admin Login:**" >> $GITHUB_STEP_SUMMARY
          echo "- Username: \`admin\`" >> $GITHUB_STEP_SUMMARY
          echo "- Password: \`admin\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ How to Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Click the URL above to access the test site" >> $GITHUB_STEP_SUMMARY
          echo "2. Log in with the admin credentials" >> $GITHUB_STEP_SUMMARY
          echo "3. Navigate to **Structure > Content types**" >> $GITHUB_STEP_SUMMARY
          echo "4. Add the Name Pronunciation field to a content type" >> $GITHUB_STEP_SUMMARY
          echo "5. Create content and test the audio recording functionality" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### â±ï¸ Environment Availability" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This test environment will remain available for **30 minutes** from now." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Need more time?** Re-run the workflow from the Actions tab to get another 30 minutes." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Environment created at: $(date -u +"%Y-%m-%dT%H:%M:%SZ")*" >> $GITHUB_STEP_SUMMARY

      - name: Post PR comment with access details
        if: github.event_name == 'pull_request' && env.TUNNEL_URL != ''
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const tunnelUrl = process.env.TUNNEL_URL;
            const body = `## ðŸ§ª Test Environment Ready!

            Your PR has been deployed to a test environment. You can now test the **Name Pronunciation** module functionality directly in a live Drupal site.

            ### ðŸ”— Access Details

            **URL:** ${tunnelUrl}

            **Admin Login:**
            - Username: \`admin\`
            - Password: \`admin\`

            ### ðŸ“ How to Test

            1. Click the URL above to access the test site
            2. Log in with the admin credentials
            3. Navigate to **Structure > Content types**
            4. Add the Name Pronunciation field to a content type
            5. Create content and test the audio recording functionality

            ### â±ï¸ Environment Availability

            This test environment will remain available for **30 minutes** from now.

            ðŸ’¡ **Need more time?** Re-run the workflow from the Actions tab to get another 30 minutes.

            ### âš ï¸ Note

            - This is a temporary test environment
            - All data will be lost when the environment closes
            - The URL is publicly accessible but temporary

            ---

            *Environment created at: ${new Date().toISOString()}*`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Keep environment alive for reviewers
        if: github.event_name == 'pull_request' && env.TUNNEL_URL != ''
        run: |
          echo "ðŸŒ Test environment is now accessible at: $TUNNEL_URL"
          echo "ðŸ‘¤ Login credentials - Username: admin | Password: admin"
          echo ""
          echo "â±ï¸  Keeping environment alive for 30 minutes..."
          echo "   Reviewers can access and test the module during this time."
          echo ""
          echo "ðŸ’¡ Tip: This is enough time for a quick review. If you need more time,"
          echo "   you can re-run the workflow from the Actions tab."
          echo ""

          # Keep the environment alive for 30 minutes (1800 seconds)
          # This balances reviewer access time with CI resource usage
          sleep 1800

          echo ""
          echo "â° 30-minute review period has ended."
          echo "   Shutting down test environment..."

          # Cleanup
          if [ -f /tmp/tunnel.pid ]; then
            kill $(cat /tmp/tunnel.pid) 2>/dev/null || true
          fi
          if [ -f /tmp/server.pid ]; then
            kill $(cat /tmp/server.pid) 2>/dev/null || true
          fi
